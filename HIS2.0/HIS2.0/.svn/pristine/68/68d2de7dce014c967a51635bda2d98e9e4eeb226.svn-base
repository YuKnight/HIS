using System;
using System.Drawing;
using System.Collections;
using System.ComponentModel;
using System.Windows.Forms;
using System.Data;
using TrasenFrame.Classes;
using TrasenClasses.GeneralControls;
using TrasenClasses.GeneralClasses;
using YpClass;
namespace ts_yp_xtwh
{
	/// <summary>
	/// Form1 的摘要说明。
	/// </summary>
	public class Frmkwsz : System.Windows.Forms.Form
	{
		private System.Windows.Forms.StatusBar statusBar1;
		private System.Windows.Forms.StatusBarPanel statusBarPanel1;
		private System.Windows.Forms.StatusBarPanel statusBarPanel2;
		private myDataGrid.myDataGrid myDataGrid1;
		private System.Windows.Forms.DataGridTableStyle dataGridTableStyle1;
		private System.Windows.Forms.DataGridTextBoxColumn dataGridTextBoxColumn1;
		private System.Windows.Forms.DataGridTextBoxColumn dataGridTextBoxColumn2;
		private System.Windows.Forms.DataGridTextBoxColumn dataGridTextBoxColumn3;
		private System.Windows.Forms.DataGridTextBoxColumn dataGridTextBoxColumn4;
		private System.Windows.Forms.GroupBox groupBox1;
		private System.Windows.Forms.Label label1;
		private System.Windows.Forms.TextBox txtdm;
		private System.Windows.Forms.Button butsave;
		private System.Windows.Forms.Button butdel;
		private System.Windows.Forms.Button butquit;
		private MenuTag _menuTag;
		private string _chineseName;
		private Form _mdiParent;
		private System.Windows.Forms.GroupBox groupBox3;
		private System.Windows.Forms.Splitter splitter1;
		private System.Windows.Forms.GroupBox groupBox2;
		private System.Windows.Forms.TreeView treeView1;
		private System.Windows.Forms.DataGridTextBoxColumn dataGridTextBoxColumn5;
		private System.Windows.Forms.DataGridBoolColumn dataGridBoolColumn1;
		private System.Windows.Forms.DataGridTextBoxColumn dataGridTextBoxColumn6;
		private System.Windows.Forms.DataGridTextBoxColumn dataGridTextBoxColumn7;
		private System.Windows.Forms.DataGridTextBoxColumn dataGridTextBoxColumn8;
		private System.Windows.Forms.DataGridTextBoxColumn dataGridTextBoxColumn9;
		private System.Windows.Forms.ImageList imageList1;
		private System.Windows.Forms.TreeView treeView2;
		private System.Windows.Forms.DataGridTextBoxColumn dataGridTextBoxColumn10;
		private System.Windows.Forms.DataGridTextBoxColumn dataGridTextBoxColumn11;
		private System.ComponentModel.IContainer components;

		public Frmkwsz(MenuTag menuTag,string chineseName,Form mdiParent)
		{
			//
			// Windows 窗体设计器支持所必需的
			//
			InitializeComponent();
			_menuTag=menuTag;
			_chineseName=chineseName;
			_mdiParent=mdiParent;
			this.Text=_chineseName;

			//
			// TODO: 在 InitializeComponent 调用后添加任何构造函数代码
			//
		}

		/// <summary>
		/// 清理所有正在使用的资源。
		/// </summary>
		protected override void Dispose( bool disposing )
		{
			if( disposing )
			{
				if (components != null) 
				{
					components.Dispose();
				}
			}
			base.Dispose( disposing );
		}

		#region Windows 窗体设计器生成的代码
		/// <summary>
		/// 设计器支持所需的方法 - 不要使用代码编辑器修改
		/// 此方法的内容。
		/// </summary>
		private void InitializeComponent()
		{
			this.components = new System.ComponentModel.Container();
			System.Resources.ResourceManager resources = new System.Resources.ResourceManager(typeof(Frmkwsz));
			this.statusBar1 = new System.Windows.Forms.StatusBar();
			this.statusBarPanel1 = new System.Windows.Forms.StatusBarPanel();
			this.statusBarPanel2 = new System.Windows.Forms.StatusBarPanel();
			this.myDataGrid1 = new myDataGrid.myDataGrid();
			this.dataGridTableStyle1 = new System.Windows.Forms.DataGridTableStyle();
			this.dataGridTextBoxColumn1 = new System.Windows.Forms.DataGridTextBoxColumn();
			this.dataGridTextBoxColumn6 = new System.Windows.Forms.DataGridTextBoxColumn();
			this.dataGridTextBoxColumn2 = new System.Windows.Forms.DataGridTextBoxColumn();
			this.dataGridTextBoxColumn3 = new System.Windows.Forms.DataGridTextBoxColumn();
			this.dataGridTextBoxColumn4 = new System.Windows.Forms.DataGridTextBoxColumn();
			this.dataGridTextBoxColumn7 = new System.Windows.Forms.DataGridTextBoxColumn();
			this.dataGridTextBoxColumn5 = new System.Windows.Forms.DataGridTextBoxColumn();
			this.dataGridBoolColumn1 = new System.Windows.Forms.DataGridBoolColumn();
			this.dataGridTextBoxColumn8 = new System.Windows.Forms.DataGridTextBoxColumn();
			this.dataGridTextBoxColumn9 = new System.Windows.Forms.DataGridTextBoxColumn();
			this.dataGridTextBoxColumn11 = new System.Windows.Forms.DataGridTextBoxColumn();
			this.dataGridTextBoxColumn10 = new System.Windows.Forms.DataGridTextBoxColumn();
			this.groupBox1 = new System.Windows.Forms.GroupBox();
			this.butquit = new System.Windows.Forms.Button();
			this.butdel = new System.Windows.Forms.Button();
			this.butsave = new System.Windows.Forms.Button();
			this.txtdm = new System.Windows.Forms.TextBox();
			this.label1 = new System.Windows.Forms.Label();
			this.groupBox3 = new System.Windows.Forms.GroupBox();
			this.treeView1 = new System.Windows.Forms.TreeView();
			this.imageList1 = new System.Windows.Forms.ImageList(this.components);
			this.splitter1 = new System.Windows.Forms.Splitter();
			this.groupBox2 = new System.Windows.Forms.GroupBox();
			this.treeView2 = new System.Windows.Forms.TreeView();
			((System.ComponentModel.ISupportInitialize)(this.statusBarPanel1)).BeginInit();
			((System.ComponentModel.ISupportInitialize)(this.statusBarPanel2)).BeginInit();
			((System.ComponentModel.ISupportInitialize)(this.myDataGrid1)).BeginInit();
			this.groupBox1.SuspendLayout();
			this.groupBox3.SuspendLayout();
			this.groupBox2.SuspendLayout();
			this.SuspendLayout();
			// 
			// statusBar1
			// 
			this.statusBar1.Location = new System.Drawing.Point(304, 461);
			this.statusBar1.Name = "statusBar1";
			this.statusBar1.Panels.AddRange(new System.Windows.Forms.StatusBarPanel[] {
																						  this.statusBarPanel1,
																						  this.statusBarPanel2});
			this.statusBar1.ShowPanels = true;
			this.statusBar1.Size = new System.Drawing.Size(724, 24);
			this.statusBar1.TabIndex = 0;
			this.statusBar1.Text = "statusBar1";
			// 
			// statusBarPanel1
			// 
			this.statusBarPanel1.Width = 300;
			// 
			// statusBarPanel2
			// 
			this.statusBarPanel2.Width = 1001;
			// 
			// myDataGrid1
			// 
			this.myDataGrid1.BackgroundColor = System.Drawing.Color.White;
			this.myDataGrid1.CaptionVisible = false;
			this.myDataGrid1.DataMember = "";
			this.myDataGrid1.Dock = System.Windows.Forms.DockStyle.Fill;
			this.myDataGrid1.HeaderForeColor = System.Drawing.SystemColors.ControlText;
			this.myDataGrid1.Location = new System.Drawing.Point(3, 17);
			this.myDataGrid1.Name = "myDataGrid1";
			this.myDataGrid1.Size = new System.Drawing.Size(718, 465);
			this.myDataGrid1.TabIndex = 2;
			this.myDataGrid1.TableStyles.AddRange(new System.Windows.Forms.DataGridTableStyle[] {
																									this.dataGridTableStyle1});
			this.myDataGrid1.myKeyDown += new myDataGrid.myDelegate(this.myDataGrid1_myKeyDown);
			// 
			// dataGridTableStyle1
			// 
			this.dataGridTableStyle1.AllowSorting = false;
			this.dataGridTableStyle1.DataGrid = this.myDataGrid1;
			this.dataGridTableStyle1.GridColumnStyles.AddRange(new System.Windows.Forms.DataGridColumnStyle[] {
																												  this.dataGridTextBoxColumn1,
																												  this.dataGridTextBoxColumn6,
																												  this.dataGridTextBoxColumn2,
																												  this.dataGridTextBoxColumn3,
																												  this.dataGridTextBoxColumn4,
																												  this.dataGridTextBoxColumn7,
																												  this.dataGridTextBoxColumn5,
																												  this.dataGridBoolColumn1,
																												  this.dataGridTextBoxColumn8,
																												  this.dataGridTextBoxColumn9,
																												  this.dataGridTextBoxColumn11,
																												  this.dataGridTextBoxColumn10});
			this.dataGridTableStyle1.HeaderForeColor = System.Drawing.SystemColors.ControlText;
			this.dataGridTableStyle1.MappingName = "";
			// 
			// dataGridTextBoxColumn1
			// 
			this.dataGridTextBoxColumn1.Format = "";
			this.dataGridTextBoxColumn1.FormatInfo = null;
			this.dataGridTextBoxColumn1.HeaderText = "序号";
			this.dataGridTextBoxColumn1.MappingName = "";
			this.dataGridTextBoxColumn1.ReadOnly = true;
			this.dataGridTextBoxColumn1.Width = 40;
			// 
			// dataGridTextBoxColumn6
			// 
			this.dataGridTextBoxColumn6.Format = "";
			this.dataGridTextBoxColumn6.FormatInfo = null;
			this.dataGridTextBoxColumn6.HeaderText = "编号";
			this.dataGridTextBoxColumn6.MappingName = "";
			this.dataGridTextBoxColumn6.Width = 75;
			// 
			// dataGridTextBoxColumn2
			// 
			this.dataGridTextBoxColumn2.Format = "";
			this.dataGridTextBoxColumn2.FormatInfo = null;
			this.dataGridTextBoxColumn2.HeaderText = "名称";
			this.dataGridTextBoxColumn2.MappingName = "";
			this.dataGridTextBoxColumn2.Width = 120;
			// 
			// dataGridTextBoxColumn3
			// 
			this.dataGridTextBoxColumn3.Format = "";
			this.dataGridTextBoxColumn3.FormatInfo = null;
			this.dataGridTextBoxColumn3.HeaderText = "拼音码";
			this.dataGridTextBoxColumn3.MappingName = "";
			this.dataGridTextBoxColumn3.Width = 75;
			// 
			// dataGridTextBoxColumn4
			// 
			this.dataGridTextBoxColumn4.Format = "";
			this.dataGridTextBoxColumn4.FormatInfo = null;
			this.dataGridTextBoxColumn4.HeaderText = "五笔码";
			this.dataGridTextBoxColumn4.MappingName = "";
			this.dataGridTextBoxColumn4.Width = 75;
			// 
			// dataGridTextBoxColumn7
			// 
			this.dataGridTextBoxColumn7.Format = "";
			this.dataGridTextBoxColumn7.FormatInfo = null;
			this.dataGridTextBoxColumn7.HeaderText = "描述";
			this.dataGridTextBoxColumn7.MappingName = "";
			this.dataGridTextBoxColumn7.Width = 75;
			// 
			// dataGridTextBoxColumn5
			// 
			this.dataGridTextBoxColumn5.Format = "";
			this.dataGridTextBoxColumn5.FormatInfo = null;
			this.dataGridTextBoxColumn5.HeaderText = "所属上级编目";
			this.dataGridTextBoxColumn5.MappingName = "";
			this.dataGridTextBoxColumn5.Width = 120;
			// 
			// dataGridBoolColumn1
			// 
			this.dataGridBoolColumn1.AllowNull = false;
			this.dataGridBoolColumn1.FalseValue = ((short)(0));
			this.dataGridBoolColumn1.HeaderText = "禁用";
			this.dataGridBoolColumn1.MappingName = "";
			this.dataGridBoolColumn1.NullText = "0";
			this.dataGridBoolColumn1.NullValue = ((object)(resources.GetObject("dataGridBoolColumn1.NullValue")));
			this.dataGridBoolColumn1.TrueValue = ((short)(1));
			this.dataGridBoolColumn1.Width = 40;
			// 
			// dataGridTextBoxColumn8
			// 
			this.dataGridTextBoxColumn8.Format = "";
			this.dataGridTextBoxColumn8.FormatInfo = null;
			this.dataGridTextBoxColumn8.HeaderText = "FID";
			this.dataGridTextBoxColumn8.MappingName = "";
			this.dataGridTextBoxColumn8.ReadOnly = true;
			this.dataGridTextBoxColumn8.Width = 0;
			// 
			// dataGridTextBoxColumn9
			// 
			this.dataGridTextBoxColumn9.Format = "";
			this.dataGridTextBoxColumn9.FormatInfo = null;
			this.dataGridTextBoxColumn9.HeaderText = "ID";
			this.dataGridTextBoxColumn9.MappingName = "";
			this.dataGridTextBoxColumn9.ReadOnly = true;
			this.dataGridTextBoxColumn9.Width = 0;
			// 
			// dataGridTextBoxColumn11
			// 
			this.dataGridTextBoxColumn11.Format = "";
			this.dataGridTextBoxColumn11.FormatInfo = null;
			this.dataGridTextBoxColumn11.HeaderText = "yjdbz";
			this.dataGridTextBoxColumn11.MappingName = "";
			this.dataGridTextBoxColumn11.ReadOnly = true;
			this.dataGridTextBoxColumn11.Width = 0;
			// 
			// dataGridTextBoxColumn10
			// 
			this.dataGridTextBoxColumn10.Format = "";
			this.dataGridTextBoxColumn10.FormatInfo = null;
			this.dataGridTextBoxColumn10.HeaderText = "排序";
			this.dataGridTextBoxColumn10.MappingName = "";
			this.dataGridTextBoxColumn10.Width = 50;
			// 
			// groupBox1
			// 
			this.groupBox1.Controls.Add(this.butquit);
			this.groupBox1.Controls.Add(this.butdel);
			this.groupBox1.Controls.Add(this.butsave);
			this.groupBox1.Controls.Add(this.txtdm);
			this.groupBox1.Controls.Add(this.label1);
			this.groupBox1.Dock = System.Windows.Forms.DockStyle.Bottom;
			this.groupBox1.Location = new System.Drawing.Point(304, 397);
			this.groupBox1.Name = "groupBox1";
			this.groupBox1.Size = new System.Drawing.Size(724, 64);
			this.groupBox1.TabIndex = 4;
			this.groupBox1.TabStop = false;
			this.groupBox1.Text = "操作";
			// 
			// butquit
			// 
			this.butquit.Location = new System.Drawing.Point(416, 16);
			this.butquit.Name = "butquit";
			this.butquit.Size = new System.Drawing.Size(96, 32);
			this.butquit.TabIndex = 4;
			this.butquit.Text = "退出(&Q)";
			this.butquit.Click += new System.EventHandler(this.butquit_Click);
			// 
			// butdel
			// 
			this.butdel.Location = new System.Drawing.Point(312, 16);
			this.butdel.Name = "butdel";
			this.butdel.Size = new System.Drawing.Size(96, 32);
			this.butdel.TabIndex = 3;
			this.butdel.Text = "删除(&D)";
			this.butdel.Click += new System.EventHandler(this.butdel_Click);
			// 
			// butsave
			// 
			this.butsave.Location = new System.Drawing.Point(208, 16);
			this.butsave.Name = "butsave";
			this.butsave.Size = new System.Drawing.Size(96, 32);
			this.butsave.TabIndex = 3;
			this.butsave.Text = "保存(&S)";
			this.butsave.Click += new System.EventHandler(this.butsave_Click);
			// 
			// txtdm
			// 
			this.txtdm.Location = new System.Drawing.Point(68, 24);
			this.txtdm.Name = "txtdm";
			this.txtdm.Size = new System.Drawing.Size(108, 21);
			this.txtdm.TabIndex = 4;
			this.txtdm.Text = "";
			this.txtdm.Visible = false;
			this.txtdm.KeyUp += new System.Windows.Forms.KeyEventHandler(this.txtdm_KeyUp);
			// 
			// label1
			// 
			this.label1.Location = new System.Drawing.Point(38, 28);
			this.label1.Name = "label1";
			this.label1.Size = new System.Drawing.Size(48, 16);
			this.label1.TabIndex = 0;
			this.label1.Text = "查找";
			this.label1.Visible = false;
			// 
			// groupBox3
			// 
			this.groupBox3.Controls.Add(this.treeView1);
			this.groupBox3.Dock = System.Windows.Forms.DockStyle.Left;
			this.groupBox3.Location = new System.Drawing.Point(0, 0);
			this.groupBox3.Name = "groupBox3";
			this.groupBox3.Size = new System.Drawing.Size(304, 485);
			this.groupBox3.TabIndex = 6;
			this.groupBox3.TabStop = false;
			this.groupBox3.Text = "库位编目";
			// 
			// treeView1
			// 
			this.treeView1.Dock = System.Windows.Forms.DockStyle.Fill;
			this.treeView1.ImageIndex = 2;
			this.treeView1.ImageList = this.imageList1;
			this.treeView1.Location = new System.Drawing.Point(3, 17);
			this.treeView1.Name = "treeView1";
			this.treeView1.SelectedImageIndex = 2;
			this.treeView1.Size = new System.Drawing.Size(298, 465);
			this.treeView1.TabIndex = 0;
			this.treeView1.AfterExpand += new System.Windows.Forms.TreeViewEventHandler(this.treeView1_AfterSelect);
			this.treeView1.AfterSelect += new System.Windows.Forms.TreeViewEventHandler(this.treeView1_AfterSelect);
			// 
			// imageList1
			// 
			this.imageList1.ImageSize = new System.Drawing.Size(16, 16);
			this.imageList1.ImageStream = ((System.Windows.Forms.ImageListStreamer)(resources.GetObject("imageList1.ImageStream")));
			this.imageList1.TransparentColor = System.Drawing.Color.Transparent;
			// 
			// splitter1
			// 
			this.splitter1.Location = new System.Drawing.Point(304, 0);
			this.splitter1.Name = "splitter1";
			this.splitter1.Size = new System.Drawing.Size(5, 397);
			this.splitter1.TabIndex = 7;
			this.splitter1.TabStop = false;
			// 
			// groupBox2
			// 
			this.groupBox2.Controls.Add(this.myDataGrid1);
			this.groupBox2.Dock = System.Windows.Forms.DockStyle.Fill;
			this.groupBox2.Location = new System.Drawing.Point(304, 0);
			this.groupBox2.Name = "groupBox2";
			this.groupBox2.Size = new System.Drawing.Size(724, 485);
			this.groupBox2.TabIndex = 8;
			this.groupBox2.TabStop = false;
			this.groupBox2.Text = "当前编目的子目录";
			// 
			// treeView2
			// 
			this.treeView2.CheckBoxes = true;
			this.treeView2.ImageIndex = 2;
			this.treeView2.ImageList = this.imageList1;
			this.treeView2.Location = new System.Drawing.Point(136, 32);
			this.treeView2.Name = "treeView2";
			this.treeView2.SelectedImageIndex = 2;
			this.treeView2.Size = new System.Drawing.Size(376, 312);
			this.treeView2.TabIndex = 1;
			this.treeView2.Visible = false;
			this.treeView2.AfterCheck += new System.Windows.Forms.TreeViewEventHandler(this.treeView2_AfterCheck);
			// 
			// Frmkwsz
			// 
			this.AutoScaleBaseSize = new System.Drawing.Size(6, 14);
			this.ClientSize = new System.Drawing.Size(1028, 485);
			this.Controls.Add(this.treeView2);
			this.Controls.Add(this.splitter1);
			this.Controls.Add(this.groupBox1);
			this.Controls.Add(this.statusBar1);
			this.Controls.Add(this.groupBox2);
			this.Controls.Add(this.groupBox3);
			this.KeyPreview = true;
			this.Name = "Frmkwsz";
			this.WindowState = System.Windows.Forms.FormWindowState.Maximized;
			this.Load += new System.EventHandler(this.Frmsccj_Load);
			this.KeyUp += new System.Windows.Forms.KeyEventHandler(this.Frmkwsz_KeyUp);
			((System.ComponentModel.ISupportInitialize)(this.statusBarPanel1)).EndInit();
			((System.ComponentModel.ISupportInitialize)(this.statusBarPanel2)).EndInit();
			((System.ComponentModel.ISupportInitialize)(this.myDataGrid1)).EndInit();
			this.groupBox1.ResumeLayout(false);
			this.groupBox3.ResumeLayout(false);
			this.groupBox2.ResumeLayout(false);
			this.ResumeLayout(false);

		}
		#endregion

		/// <summary>
		/// 应用程序的主入口点。
		/// </summary>
		[STAThread]


		private void Frmsccj_Load(object sender, System.EventArgs e)
		{
			try
			{
				//初始化
				DataTable myTb=new DataTable();
			
				for(int i=0;i<=this.myDataGrid1.TableStyles[0].GridColumnStyles.Count-1;i++) 
				{	
					if(this.myDataGrid1.TableStyles[0].GridColumnStyles[i].GetType().ToString()=="System.Windows.Forms.DataGridBoolColumn")
						myTb.Columns.Add(this.myDataGrid1.TableStyles[0].GridColumnStyles[i].HeaderText,Type.GetType("System.Int16"));	
					else
						myTb.Columns.Add(this.myDataGrid1.TableStyles[0].GridColumnStyles[i].HeaderText,Type.GetType("System.String"));	
									   
					this.myDataGrid1.TableStyles[0].GridColumnStyles[i].MappingName=this.myDataGrid1.TableStyles[0].GridColumnStyles[i].HeaderText;
					this.myDataGrid1.TableStyles[0].GridColumnStyles[i].NullText="";
				}

				DataRow row=myTb.NewRow();
				row["序号"]="1";
				myTb.Rows.Add(row);
			    myTb.TableName="Tb";
				this.myDataGrid1.DataSource=myTb;
				this.myDataGrid1.TableStyles[0].MappingName ="Tb";
				this.AddData("");
			}
			catch(System.Exception err)
			{
				MessageBox.Show("发生错误"+err.Message);
			}
		}

	
		private void AddData(string ss)
		{
			this.treeView1.Nodes.Clear();
			this.treeView2.Nodes.Clear();
			this.treeView1.ImageList=this.imageList1;
			TreeNode node = treeView1.Nodes.Add("库位目录");
			node.Tag="0";
			node.ImageIndex=0;
			AddTreeViewNode(node);
			
			TreeNode node1 = treeView2.Nodes.Add("库位目录");
			node1.Tag="0";
			node1.ImageIndex=0;
			AddTreeViewNode(node1);

			DataTable tb=(DataTable)this.myDataGrid1.DataSource;
			tb.Rows.Clear();
		}

		private void AddTreeViewNode(TreeNode treeNode)
		{
			
			DataTable tb=new DataTable();
			string ssql="";
			ssql="select 0 序号,kwbh 编号,kwmc  名称,pym 拼音码,wbm 五笔码,kwms 描述,dbo.fun_yp_kwmc(fid,deptid) 所属上级编目,cast(bdelete as smallint) 禁用,fid,id,yjdbz,pxid 排序 from yp_hwh where fid="+Convert.ToInt64(Convertor.IsNull(treeNode.Tag,"-10"))+" and deptid="+InstanceForm.BCurrentDept.DeptId +" order by fid ";
			tb=InstanceForm.BDatabase.GetDataTable(ssql);

			treeNode.Nodes.Clear();
			for(int i=0;i<=tb.Rows.Count-1;i++)
			{
				TreeNode Cnode = treeNode.Nodes.Add(tb.Rows[i]["名称"].ToString());
				Cnode.Tag=tb.Rows[i]["id"];
				if (tb.Rows[i]["yjdbz"].ToString()=="1") Cnode.ImageIndex=1; else Cnode.ImageIndex=0;
				AddTreeViewNode(Cnode);			
			}
		}


		private bool myDataGrid1_myKeyDown(ref System.Windows.Forms.Message msg, System.Windows.Forms.Keys keyData)
		{
			try
			{
				
				DataTable tb=(DataTable)this.myDataGrid1.DataSource ;
				int nrow=this.myDataGrid1.CurrentCell.RowNumber;
				int ncol=this.myDataGrid1.CurrentCell.ColumnNumber;
				int nkey=Convert.ToInt32(keyData);
				string columnName=this.myDataGrid1.TableStyles[0].GridColumnStyles[ncol].HeaderText.Trim();
				if (nrow>tb.Rows.Count-1) return true;

//				if (Convert.ToInt32(Convertor.IsNull(tb.Rows[nrow]["fid"].ToString(),"0"))==0)
//				{
//					tb.Rows[nrow]["所属上级编目"]=this.treeView1.SelectedNode.Text;
//					tb.Rows[nrow]["fid"]=this.treeView1.SelectedNode.Tag;
//				}


				if (columnName.Trim()=="名称" && nkey==13)
				{
					string coltext="";
					DataGridTextBoxColumn txtCol=(DataGridTextBoxColumn)this.myDataGrid1.TableStyles[0].GridColumnStyles[ncol];
					coltext=txtCol.TextBox.Text;
					if (coltext.Trim()=="") return true;

					if (nrow>=tb.Rows.Count-1)
					{
						DataRow row=tb.NewRow();
						row["序号"]=nrow+2;
						row["禁用"]=(short)0;
						tb.Rows.Add(row);
					}

					tb.Rows[nrow]["名称"]=coltext;
					tb.Rows[nrow]["拼音码"]=PubStaticFun.GetPYWBM(coltext,0);
					tb.Rows[nrow]["五笔码"]=PubStaticFun.GetPYWBM(coltext,1);
					tb.Rows[nrow]["所属上级编目"]=this.treeView1.SelectedNode.Text;
					tb.Rows[nrow]["fid"]=this.treeView1.SelectedNode.Tag;
				}

				if (nkey==13 && columnName!="禁用")
					this.myDataGrid1.CurrentCell=new DataGridCell(nrow,ncol+1);
				if (nkey==13 && columnName=="禁用")
					this.myDataGrid1.CurrentCell=new DataGridCell(nrow+1,1);

				if (columnName.Trim()=="所属上级编目" && nkey!=13)
				{
					Point point=new Point(this.myDataGrid1.GetCellBounds(nrow,ncol).Left-50,this.myDataGrid1.GetCellBounds(nrow,ncol).Top +this.myDataGrid1.Top+this.myDataGrid1.GetCellBounds(nrow,ncol).Height);
					this.treeView2.Location=point;
					this.treeView2.Visible=true;
					this.myDataGrid1.Enabled=false;

				}
				

			}
			catch(System.Exception err)
			{
				MessageBox.Show("发生错误"+err.Message );
			}
			return false;
		}

	
		private void txtdm_KeyUp(object sender, System.Windows.Forms.KeyEventArgs e)
		{
			try
			{
				SelectTree1Node(txtdm.Text.Trim(),null);
			}
			catch(System.Exception err)
			{
				MessageBox.Show("发生错误"+err.Message);
			}

		}

		private void butdel_Click(object sender, System.EventArgs e)
		{
			try
			{
				DataTable tb=(DataTable)this.myDataGrid1.DataSource ;
				int nrow=this.myDataGrid1.CurrentCell.RowNumber;
				if (nrow>tb.Rows.Count-1) return;
				int ID=Convert.ToInt32(Convertor.IsNull(tb.Rows[nrow]["id"],"0"));
				//看是否有过使用记录
				string ssql="select * from yp_hwh where fid="+ID+" and deptid="+InstanceForm.BCurrentDept.DeptId +"";
				DataTable tab=InstanceForm.BDatabase.GetDataTable(ssql);
				if (tab.Rows.Count>0){MessageBox.Show("对不起，这个节点还有子节点，请先删除子节点");return;}

				ssql="select * from yk_kcph where kwid="+ID+"";
				DataTable tab1=InstanceForm.BDatabase.GetDataTable(ssql);
				if (tab1.Rows.Count>0){MessageBox.Show("对不起，这个货位在库存管理中已使用了，不能删除");return;}

				ssql="delete from yp_hwh where id="+ID +" and deptid="+InstanceForm.BCurrentDept.DeptId +"";
				InstanceForm.BDatabase.DoCommand(ssql);
				MessageBox.Show("删除成功");
				DataRow row=tb.Rows[nrow];
				tb.Rows.Remove(row);
			}
			catch(System.Exception err)
			{
				MessageBox.Show("发生错误");
			}
		}

		private void butquit_Click(object sender, System.EventArgs e)
		{
			this.Close();
		}

		private void butsave_Click(object sender, System.EventArgs e)
		{


			try
			{
				this.butsave.Enabled=false;
				InstanceForm.BDatabase.BeginTransaction();

				string ssql="";
				long fid=0;string kwbh="";string kwmc="";int pxid=0;string kwms="";int bdelete=0;string pym="";string wbm="";
				DataTable tb=(DataTable)this.myDataGrid1.DataSource;
				for(int i=0;i<=tb.Rows.Count-1;i++)
				{

					int ID=Convert.ToInt32(Convertor.IsNull(tb.Rows[i]["id"],"0"));
					fid=Convert.ToInt64(Convertor.IsNull(tb.Rows[i]["fid"],"0"));
					kwbh=tb.Rows[i]["编号"].ToString();
					kwmc=tb.Rows[i]["名称"].ToString();
					pxid=Convert.ToInt32(Convertor.IsNull(tb.Rows[i]["排序"],"0"));
					kwms=tb.Rows[i]["描述"].ToString();
					bdelete=Convert.ToInt32(Convertor.IsNull(tb.Rows[i]["禁用"],"0"));
					pym=tb.Rows[i]["拼音码"].ToString();
					wbm=tb.Rows[i]["五笔码"].ToString();

					if (kwmc.Trim()!="")
					{
						if (ID==0)
							ssql="insert into yp_hwh(fid,kwbh,kwmc,pxid,kwms,bdelete,pym,wbm,deptid) values("+fid+",'"+kwbh+"','"+kwmc+"',"+pxid+""+
								",'"+kwms+"',"+bdelete+",'"+pym+"','"+wbm+"',"+InstanceForm.BCurrentDept.DeptId +") ";
						else
							ssql="update yp_hwh set(fid,kwbh,kwmc,pxid,kwms,bdelete,pym,wbm)=("+fid+",'"+kwbh+"','"+kwmc+"',"+pxid+""+
								",'"+kwms+"',"+bdelete+",'"+pym+"','"+wbm+"') where id="+ID+" and deptid="+InstanceForm.BCurrentDept.DeptId+"";

						InstanceForm.BDatabase.DoCommand(ssql);

						ssql="update yp_hwh set yjdbz=0 where id="+fid+"";
						InstanceForm.BDatabase.DoCommand(ssql);

					}
				}

				InstanceForm.BDatabase.CommitTransaction();
				MessageBox.Show("保存成功");
				this.butsave.Enabled=true;
				this.AddData("");
			}
			catch(System.Exception err)
			{
				this.butsave.Enabled=true;
				InstanceForm.BDatabase.RollbackTransaction();
				MessageBox.Show("发生错误"+err.Message);
			}
		}



		private void treeView1_AfterSelect(object sender, System.Windows.Forms.TreeViewEventArgs e)
		{
			try
			{
				this.treeView2.Visible=false;
				SelectTree1Node("",e);
			}
			catch(System.Exception err)
			{
				MessageBox.Show("发生错误"+err.Message);
			}
		}


		private void treeView2_AfterCheck(object sender, System.Windows.Forms.TreeViewEventArgs e)
		{
			DataTable tb=(DataTable)this.myDataGrid1.DataSource;
			int nrow=this.myDataGrid1.CurrentCell.RowNumber;
			if (nrow>tb.Rows.Count-1) return;
			
			if (e.Node.Tag.ToString()=="-10")
			{
				MessageBox.Show("这是一个空节点,请重新选择");
				return;
			}

			int id=Convert.ToInt32(Convertor.IsNull(tb.Rows[nrow]["id"],"0"));
			int fid=Convert.ToInt32(Convertor.IsNull(e.Node.Tag,"0"));
			if (id==fid){MessageBox.Show("上级目录不能选择自己");return;}
			if (fid==0){MessageBox.Show("当前节点不能选择");return;}
			tb.Rows[nrow]["所属上级编目"]=e.Node.Text ;
			tb.Rows[nrow]["fid"]=e.Node.Tag.ToString();

			this.treeView2.Visible=false;
			this.myDataGrid1.Enabled=true;
			this.myDataGrid1.CurrentCell=new DataGridCell(nrow,6);

		}

		private void Frmkwsz_KeyUp(object sender, System.Windows.Forms.KeyEventArgs e)
		{
			int nrow=this.myDataGrid1.CurrentCell.RowNumber ;
			if (Convert.ToInt32(e.KeyCode)==27)
			{
				this.treeView2.Visible=false;
				this.myDataGrid1.Enabled=true;
				this.myDataGrid1.CurrentCell=new DataGridCell(nrow,6);
			}
		}

		private void SelectTree1Node(string ssql,System.Windows.Forms.TreeViewEventArgs e)
		{
			DataTable tb=new DataTable();
			string ss="";
			if (ssql.Trim()=="")
				ss="select 0 序号,kwbh 编号,kwmc  名称,pym 拼音码,wbm 五笔码,kwms 描述,dbo.fun_yp_kwmc(fid,deptid) 所属上级编目,cast(bdelete as smallint) 禁用,fid,id,yjdbz,pxid 排序 from yp_hwh where fid="+Convert.ToInt64(Convertor.IsNull(e.Node.Tag,"-10"))+" and deptid="+InstanceForm.BCurrentDept.DeptId +" order by fid ";
			else
				ss="select 0 序号,kwbh 编号,kwmc  名称,pym 拼音码,wbm 五笔码,kwms 描述,dbo.fun_yp_kwmc(fid,deptid) 所属上级编目,cast(bdelete as smallint) 禁用,fid,id,yjdbz,pxid 排序 from yp_hwh where deptid="+InstanceForm.BCurrentDept.DeptId+" and (wbm like '"+ssql.Trim()+"%' or pym like '"+ssql.Trim()+"%') order by fid ";
			tb=InstanceForm.BDatabase.GetDataTable(ss);
			
			DataRow row=tb.NewRow();
			row["序号"]=tb.Rows.Count+1;
			row["禁用"]=(short)0;
			tb.Rows.Add(row);

			tb.TableName="Tb";
			this.myDataGrid1.DataSource=tb;
			this.myDataGrid1.TableStyles[0].MappingName="Tb";
			this.myDataGrid1.CurrentCell=new DataGridCell(0,0);

		}
	}
}
